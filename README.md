# Bayesian-Monitoring-of-COVID-19-in-Sweden

## About
This README describes the code we use in the paper with the same name
and allows the reader to replicate the paper results.

## Authors
* Robin Marin (robin.marin 'at' it.uu.se),
* Håkan Runvik (hakan.runvik 'at' it.uu.se),
* Alexander Medvedev (alexander 'at' it.uu.se), and
* Stefan Engblom (stefane 'at' it.uu.se)

# Installation
1. Clone the repository
2. Make sure that the dependencies are installed and initialzed
3. Initialize the code-base by: in the main directory run `startup` in
   a MATLAB environment.
4. The code and data files are now accessable to be referenced.


# Results
Basic functionallity to generate results we give in the paper. If
further explanation is wanted, see the extensive Matlab `help`
functions each funciton has been outfitted with.

## Data (/data/)
To access the data run `d = loadData(rep)` where `rep` is a specificed
directory listed under `help loadData`, e.g., `C19`. Raw .csv files
are stored under `/data/sources/REP` for the same definition of `REP`
as above. We strongly suggest using our pre-processing steps on the
data before performing any calculations, see the following flow
```
Data = loadData('C19');
Data = polishData(Data,'D','Dinc',1);
Data = smoothData(Data,{'D' 'H' 'W'},{'Dinc' [] []});
```

## Kalman filter (/kalman/)
The main function for the Kalman filter is `C19filt(...)`. The
function makes further calls to subordinate functions `/kalman/auxil/`
that handle the The construction and time propagation of the Kalman
filter approximation.

A rough evaluation of the prediction capabilities of the posterior
Kalman fitler is given by `C19filt_lag(...)` which is the Kalman
filter extended to enables k-day ahead (lag) predictions without data
observations.

## Prior (/inference/)
`rates = priorenger(N)` gives `N` samples from the prior, and `dens =
priorenger(rates)` computes the prior density of the samples `rates`.
The empirical priors, and some defined from sources are constructed
firstly by the `genprior` script.

## Posterior (/inference/)
The posterior is stored, and accessed using `rates =
posteriorenger(file)` where file references a specific posterior file.
We have stored our generated posterior files under
`inference/results/`. The function includes a functionallity of
referencing a list of posterior files and computing a weighted average
of them, e.g., Swedish national average weighted by regional
population size.

## KLAM (/inference/SLAM/)
We generate samples from the approximate posterior by and
implementation of Kalman likelihood adaptive Metropolis.  We supply
the reader with the user friendly wrapper script `slam_parachain`
which calls the underlying functions (`slam_init`, `AM`, `logSL`)
using MATLAB's `parfor` framework. Generating samples are expensive,
and we include the code for reference, but the results we generated
are acceable by the posterior function we reference above..

## DynOpt (/inference/dynamic_beta/)
The temporal upscaling (bootstrap on the margin) of the 4-week
reproduction number generated by `dynamic_beta_ML`.

## Weekly predictions (/weekly/)
We perform K-day ahead prediction using the posterior Kalman filter
in `weekly_prediction`, see examples.

## Bootstrap (/URDME/)
The boostrap replicates we use for bias estimation are generated using
URDME. The URDME-model script `covid19enger` defines the rates model
and `covid19enger_run_post` generates the samples. Our posterior
samples are generated using a national weighted mean posterior.

## Reproduction of results
The result files needed for the examples are already given in this
repository, but if the reader still wants to reproduce the results on
his/hers device the following (in this order as well) would suffice
```
% KLAM posteriors
rep = 'C19';
slam_parachain;

% Bootstrap on the margin, temporal upscaling
dynamic_beta_ML;

% Regional Bootstraps
URDMEsamples;

% Find the posterior of the bootstrap replicates
rep = 'URDME1'
slam_parachain;
rep = 'URDME2'
slam_parachain;
rep = 'URDME3'
slam_parachain;

% and the temporal upscaling
rep = 'URDME'
dynamic_beta_ML;

% Finally compute the bias
bootstraptable;

```

# Examples (paper/predict/)
All the examples are referenced to a presented figure in the paper.

Prior to generating the figure, simulation files are needed for some
the figures/examples listed below. In order to run the properly we
suggest you first generate them by first running the `laggen` script.
It will take a while, but it needs only to be called once. The `laggen` call should be
called as follows
```
% *suggested approach* to reproduce the Figures in the paper.
type = 1;
reg = [1 2 22];
laggen;
type = 2;
reg = [2]
laggen;


% if all data is wanted
type = 1;
reg = 1:22;
laggen; % filter output + 14 days of prediciton

type = 2;
laggen % Continous 7-day ahead prediction

```

## Figures (paper/predict/img/script)
### Fig. 2:
Illustrate the marginal prior and posterior with
`prior_posterior`. The illustration can be the weighted national
average or any combination of regional posteriors, see the variable
`reg` which include all if set to `[1:21]` or only Uppsala if `[2]`.
```
reg = [1:21]
prior_posterior; % generates the weighted national average, as in the paper.

reg = [2]
prior_posterior; % generates the same but only for Uppsala.
```
### Fig. 3:
7-day ahead predictions per region, and exemplified for Uppsala in
`lagplot`. The function unpacks prediction samples generated using
`weekly_predict` wrapper `laggen`

```
generateData=0; % if the laggen call was already made
reg = [2]; % Uppsala figure, [1] for Stockholm and so on.
lagplot;

```

### Fig. 4:
The proportion of recovered invididuals per region, and Stockholm in
particular `recovered`. Stockholm in particular because we have
included validating sources which themselves only consider that
region. The validating sources are included by .csv: [`fhmAnti`,
`fhmAntiGivare`, `RecPaperEstimate`], see the paper for the sources.
The call is simply
```
recovered; % generates the recoverd plot in the paper.
```

### Fig. 5 (& S2)
The posterior reproduction number (4-week) and the marginal boostrap
(daily) per region can be illustrated by `Rposterior`. In which the
region of interest is specified by `reglist`. In Fig. 5 `= [2]`, and
in Fig. S2 `= [1 10 12 8 9 19]`. The 4-week posterior is illustrated
using a boxplot, the daily as a red line, and for comparison (or
validation) we also include the estimate given by PHA per region.
```
clear reg
Rposterior; % generates the figures for the 7 regions in the paper

reg = [2]
Rposterior; % only generates the figure for Uppsala
```

### Fig. S1:
As the posterior Kalman filter can give an estimate of the proportion
of recovered individuals, similarly the filter can also give an
estimate of the number of symptomatic or the symptomatic
incidence. The latter is often what servailence studies (testing)
tries to uncover. In `IincFac` we do exactly this, we recover the
symtomatic incidence and compare it to the positive tests by PHA in
Stockholm and Uppsala. Figures can be generates in batch, or by region.
```
savetofile = false;
reg = [1] % Stockolm
IincFac;

savetofile = true; % the figure names are re-used and we suggest saving.
reg = [1 2] % Stockholm and Uppsala
IincFac;
```

### Fig. S4:
The pre-processing of the data (as discussed under Results → Data)
corrects the distribution of diseased incidence per weekday to achieve
one that is closer to uniformly distributed. If not close to uniform,
it is telling to be a data entry issue as nothing intrisict about the
infection should decide that one day is >5 times likely to have more
reported deaths on. The illustration is reproducable in
`weekday_smoothing`.
```
reg = 1; % Stockholm
weekday_smoothing;

reg = 2; % Uppsala
weekday_smoothing;
```

### Fig. S5:
Our effort of exploring the prior predictive distribution is given in
`priorpred`. The parameters directly samples from the prior is used as
the ones from the posterior is used in `laggen`. A first inital run
should include `gendata = true` and then it can be set to `false`. The
first run generates the prior sample predictions and save the file (it
can be large, therefore we do not include it). After it has been
generated, the file can simply be loaded the the predictive
distribution can be explored further.
```
regen=1; % generate the samples
reg=2; % Uppsala | can be swapped for othe regions, e.g., Stockholm (1).
Nprior=1e3; % number of prior samples
priorpred;

regen=0;
priorpred; % same figure, but loading the prior samples from file.
```

### Fig. S6:
The daily estimate of β is expensive to run; superlinear in the number
of days *K*. We illustrate the splitting of horizions to make the
calculations feasable in `HorizonSplitCompare`. *WARNING* this script
takes a long time to compute.
```
reg=2; % Uppsala region, as in paper.
savetofile=false;
HorizonSplitCompare;

```

### Fig. S7:
The posterior for all regions is tricker to visualize all at once. In
`errorbarsRegion` we give the posterior mean ± 1 std per region. This
quick illustration gives a quick overview of potential outlier regions
but also the similarity between regional results.
```
clear ratenames
errorbarsRegion; % load data into memory and generate figure.

errorbarsRegion; % from memory generate figure.
```

### Fig. S8:
The bootstrap samples are, as mentioned, generated using URDME. The
function `URDMEsampling` generates the samples for all regions, stores
the file, and generates the figures. The latter allows for visualized
comparison with the underlying data. There will be some missmatch
assumed as the posterior we use in the simulations is a national
average (except per the reproduction number) and therefore if the
regional posterior differed significantly from the weighted national
average, we then expect the simulations to differ more.
```
reg = [1:21]; % national average
regplot = [2];
URDMEsampling; % Only the Uppsala figure

clear regplot
URDMEsampling; % All the figures in the paper.
```

### Fig. S9:
The reproduced posterior samples on the bootstrap replicate data can
we visualized together with the weighted national average (as Fig 2)
as another marginal density in `prior_posteriorURDME`.
```
reg = [1:21]; % national average
prior_posteriorURDME; % same figure as in the paper

reg = [2];
prior_posteriorURDME; % only for Uppsala.
```

### Fig. S10:
Similarly as the boostrap replicate posterior was compared to the the
marginal posterior and prior in Fig. S9, we can include the replicate
mean for the reproduction number in `RposteriorURDME`. We only include
the files necessary for the Uppsala region plot, as given in the
paper. The following results in the same figure.
```
RposteriorURDME;
```

### Fig. S11:
To compare the the Posterior Kalman filter predictor with something,
we construct a Autoregressive (AR) model in `arx_fit`. The AR model
considers data (H,W,D) in an expanding window and makes 7-day ahead
predictions. The performance is then evaluated on the frequency of
"inside [X%] CrI" and the NRMSE per the days we have recorded for the
Kalman filter. The reasoning for only doing it on the recorded dates
is that it makes sure that the Kalman filter had not seen "future"
data when making predictions. The code also generates the Tab. S5.
```
reg=2; % Uppsala region
arx_fit; % first time loads solution into memory

arx_fit; % no new fitting, only plotting
clear ypred;
reg=1; % Stockholm data
arx_fit; % fit anew.
```

## Tables (paper/predict/tab/script)
### Tab. 1
We describr in the paper how the research underlying the paper was
used, and developed, for weekly prediction in reports published for
the local authorities. The result from those reports are summarized in
a table and `weekly_eval` extracts the results.
```
weekly_eval; % reads the table
tableWeekly % the summarized and stored .tex table
```

### Tab. 2
The Infection Fatality rate (IFR), like the reproduction number, is a
4-week dynamical parameter. We present the IFR by the `IFRtableURDME`
script. The IFR update frequency of once per month (4-week) is however
not very stable (in a loose sense) and we decide to give the
bi-monthly estimate instead. Still, by including two months in the
estimate, we observe a downward trend forming. Per region, we give an
our estimate (posterior sample) for Stockholm and Uppsala. Next we
also give the weighted national average. The posterior CrI is computed
as the marginal quantiles. The table include footnotemarks (§ and ‡)
and we use these marks to indicate that the estimate should be
considered with care.
```
clear reg, bimonthly
IFRtableURDME; % generates the same table as in the paper

reg = [2]
IFRtableURDME; % only for Uppsala

reg = [1:22]; % all regions and Sweden
IFRtableURDME

reg = [2];
bimonthly = false;
IFRtableURDME; %Uppsala but IFR per month.
```

### Tab. S4
With the estimated bias, we compute the uncertainty statistics:
Coefficient of Variation (CoV), Coefficient of Bias (CoB), and
normalized root mean square error (NRMSE), per region in
`bootstraptable`. We estimate the bias for the regional posteriors by
using the known bias of the bootstrap replicates. The bias is computed
per parameter, and as a robust estimator of the bias for the entire
region (over all parameters) we give the median instead of the mean.
Deeper investigation into the working of the table construction is to
be done by examining `posterror` which processes the posterior files
that `bootstraptable` supplies it with.
```
bootstraptable; % generates the table in the paper.
```

# Dependencies
* stenglib: https://github.com/stefanengblom/stenglib
* URDME: https://github.com/URDME/urdme
* MATLAB (>= release 2021a)

## Tested on
* Linux (Pop!_OS 20.10, 64 bit) [not yet]
* Linux (Pop!_OS 21.10, 64 bit) [not yet]
* macOS (version?) [not yet]
* Windows (version?) [not yet]
